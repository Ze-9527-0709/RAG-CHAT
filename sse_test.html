<!DOCTYPE html>
<html>
<head>
    <title>SSE Debug Test</title>
</head>
<body>
    <h2>SSE Stream Debug Test</h2>
    <div id="output"></div>
    <button onclick="testImageUpload()">Test Image Upload</button>
    
    <script>
        function testImageUpload() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Testing SSE stream...</p>';
            
            const eventSource = new EventSource('http://localhost:8000/api/chat_stream_with_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: 'test-' + Date.now(),
                    message: 'Tell me about this image',
                    image_base64: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                })
            });

            let fullText = '';
            
            eventSource.onmessage = function(event) {
                console.log('Raw event data:', JSON.stringify(event.data));
                fullText += event.data;
                output.innerHTML = `<p>Current text: ${fullText}</p>`;
            };

            eventSource.onerror = function(event) {
                console.error('SSE Error:', event);
                output.innerHTML += '<p style="color: red;">SSE Error occurred</p>';
                eventSource.close();
            };

            setTimeout(() => {
                eventSource.close();
                output.innerHTML += '<p><strong>Final result:</strong> ' + fullText + '</p>';
            }, 15000);
        }
    </script>
</body>
</html>